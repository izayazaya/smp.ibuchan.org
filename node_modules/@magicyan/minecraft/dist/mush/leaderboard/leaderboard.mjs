import { notOkResult } from '../../helpers/result.mjs';
import { convertKeysToCamelCase } from '../../helpers/format.mjs';
import { RouteBases } from '../../constants/api.mjs';
import _ from 'lodash';

async function fetchMushLeaderboard(game) {
  const url = `${RouteBases.mush}/leaderboard/${game}`;
  const response = await fetch(url);
  if (!response.ok)
    return notOkResult(response);
  const { records } = await response.json();
  const data = records.map((raw) => ({
    account: convertKeysToCamelCase(raw.account),
    avatarURL: raw.avatar_url,
    color: raw.color,
    position: raw.pos,
    game,
    get: implementMethod(game),
    ..._.omit(raw, ["account", "avatar_url", "color", "pos"])
  }));
  return { success: true, data };
}
function implementMethod(game) {
  const key = game === "skywars" ? "skywars_r1" : game === "hg" ? "hungergames" : game;
  return function getStats(stats) {
    return this[`${key}:${stats}`] ?? -1;
  };
}

export { fetchMushLeaderboard };
